<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Latihan Esei: Faedah Aktiviti Masa Lapang</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap" rel="stylesheet" />
  <style>
    body {
      box-sizing: border-box;
      scroll-behavior: smooth;
    }
    
    :root { --base-font: 22px; --content-width: 1600px; }
    html { font-size: var(--base-font); }
    body { font-family: 'Plus Jakarta Sans', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; background: #f8fafc; color: #0b0f19; }

    main {
      transition: transform 0.2s ease-in-out;
    }

    .card { background: #fff; border-radius: 16px; box-shadow: 0 4px 16px rgba(0,0,0,.05); }
    .pill { color: #0b0f19; background: rgba(0,0,0,.04); border: 1px solid rgba(0,0,0,.08); border-radius: 14px; padding: .5rem .8rem; }
    .tag { color: #0b0f19; opacity: .9; font-size: .78rem; letter-spacing: .08em; text-transform: uppercase; }
    .title { font-size: clamp(2.2rem, 2vw + 1.2rem, 3.6rem); line-height: 1.12; font-weight: 900; }

    .btn { border-radius: 14px; font-weight: 700; padding: .6rem 1.2rem; transition: all .1s ease; cursor: pointer; border: none; }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-primary:hover { background: #2563eb; }
    .btn-ghost { background: rgba(0,0,0,.06); color: #0b0f19; }
    .btn-ghost:hover { background: rgba(0,0,0,.1); }
    .btn-success { background: #10b981; color: #fff; }

    /* MFL badge */
    .mfl-badge {
      width: 56px; height: 56px; border-radius: 50%;
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      position: relative; display: flex; align-items: center; justify-content: center;
      color: white; font-size: 1.5rem;
    }

    /* Bar objektif atas */
    .obj-strip { position: sticky; top: 0; z-index: 30; background: rgba(248, 250, 252, 0.8); backdrop-filter: saturate(1.2) blur(10px); }

    /* Activity styles */
    .activity-box {
      background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
      border: 1px solid #facc15;
      border-radius: 12px;
      padding: 1.5rem;
    }

    .stimulus-box {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #0ea5e9;
      border-radius: 12px;
      padding: 1.5rem;
      line-height: 1.6;
    }
    
    .feedback-box {
        background: #f0fdf4;
        border-left: 5px solid #22c55e;
        border-radius: 8px;
        padding: 1rem;
    }
    
    .help-center {
      background: #f1f5f9;
      border-radius: 12px;
      padding: 1.5rem;
    }

    textarea.answer, textarea.editor {
      width: 100%; min-height: 120px; border-radius: 14px; border: 1px solid rgba(0,0,0,.12);
      padding: .9rem 1rem; outline: none; transition: all 0.2s ease;
    }
    textarea.answer:focus, textarea.editor:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.18); }

    /* Structure table */
    .structure-table { border-collapse: collapse; width: 100%; border-radius: 12px; overflow: hidden; }
    .structure-table th, .structure-table td { border: 1px solid #e5e7eb; padding: 0.75rem 1rem; text-align: left; }
    .structure-table th { background: #f3f4f6; font-weight: bold; }

    /* Vocabulary Helper Styles */
    .vocab-helper { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
    .vocab-button {
      width: 60px; height: 60px; border-radius: 50%;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white; border: none; font-size: 1.5rem; cursor: pointer;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
      transition: all 0.3s ease;
    }
    .vocab-button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4); }
    .vocab-panel {
      position: absolute; bottom: 80px; right: 0;
      width: 380px; max-height: 500px; background: white;
      border-radius: 16px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      overflow: hidden; transform: translateY(20px) scale(0.9);
      opacity: 0; transition: all 0.3s ease; pointer-events: none;
    }
    .vocab-panel.show { transform: translateY(0) scale(1); opacity: 1; pointer-events: all; }
    .vocab-tabs { display: flex; border-bottom: 1px solid #e5e7eb; }
    .vocab-tab { padding: 0.75rem 1rem; cursor: pointer; transition: background 0.2s; font-size: 0.9rem; font-weight: 600; flex-grow: 1; text-align: center; }
    .vocab-tab:hover { background: #f3f4f6; }
    .vocab-tab.active { background: #22c55e; color: white; }
    .vocab-content { padding: 1rem; max-height: 350px; overflow-y: auto; }
    .vocab-item {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.5rem; margin-bottom: 0.5rem; background: #f8fafc;
      border-radius: 8px; cursor: pointer; transition: all 0.2s;
      font-size: 0.9rem; border-left: 3px solid transparent;
    }
    .vocab-item:hover { background: #f0fdf4; border-left-color: #22c55e; transform: translateX(4px); }
    .vocab-icon { font-size: 1.2rem; }
    .speak-btn {
        background: none; border: none; font-size: 1.2rem; cursor: pointer;
        padding: 0.25rem; border-radius: 50%; transition: background 0.2s;
    }
    .speak-btn:hover { background: #e5e7eb; }


    /* Animations */
    @keyframes fade-in { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fade-in 0.6s ease-out forwards; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin: 20px auto;
    }

    /* Toast Notifications */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
    .toast {
        background-color: #2d3748; color: white; padding: 0.75rem 1.25rem;
        border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        opacity: 0; transform: translateX(100%);
        transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    }
    .toast.show { opacity: 1; transform: translateX(0); }
    
    .gif-container {
        width: 100%;
        height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f3f4f6;
        border-radius: 12px;
        overflow: hidden;
    }
    .gif-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .translation {
        font-size: 0.8em;
        opacity: 0.7;
        font-style: italic;
    }

    .stage-centered {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 50vh;
    }

    @media print {
      .helper, .obj-banner, .obj-strip, .btn, .vocab-helper { display: none !important; }
      .stage { box-shadow: none !important; border: none !important; }
      body { background: #fff !important; color: #000 !important; }
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toast-container"></div>
  <div class="min-h-screen">
    <!-- Banner Atas -->
    <div class="obj-banner">
      <div class="mx-auto px-6 pt-6" style="max-width: var(--content-width);">
        <div class="card p-4">
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-start gap-3">
              <span class="mfl-badge">üß†</span>
              <div>
                <div class="flex items-center gap-3">
                    <span class="font-extrabold">Latihan Esei: Faedah Aktiviti Masa Lapang</span>
                    <span class="text-xs font-mono bg-gray-200 text-gray-600 px-2 py-1 rounded-md">v2.0 (Revamped)</span>
                </div>
                <div class="opacity-80 text-sm">Essay Practice: Benefits of Leisure Activities</div>
                <div class="opacity-80 text-sm mt-1">Tema: Rekreasi dan Hiburan</div>
                <div class="opacity-80 text-sm">Theme: Recreation and Entertainment</div>
              </div>
            </div>
            <div class="text-sm opacity-75">
              Selamat Datang, <span id="studentNameDisplay" class="font-bold">Pelajar</span>!
              <div class="translation">Welcome, Student!</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bar Objektif Pembelajaran -->
    <div class="obj-strip">
      <div class="mx-auto px-6 pt-3" style="max-width: var(--content-width);">
        <div class="card p-4">
          <div class="flex items-center justify-between gap-3 flex-wrap">
            <div>
                <div class="font-extrabold">Objektif Pembelajaran</div>
                <div class="translation">Learning Objectives</div>
            </div>
            <button id="toggleObj" class="btn btn-ghost">Sembunyi / Hide</button>
          </div>
          <ul id="objList" class="mt-3 grid sm:grid-cols-3 gap-2 text-sm opacity-90">
            <li class="pill">Mengenal pasti faedah aktiviti masa lapang <div class="translation">Identify benefits of leisure activities</div></li>
            <li class="pill">Menggunakan kata hubung untuk menyambung idea <div class="translation">Use conjunctions to connect ideas</div></li>
            <li class="pill">Menulis esei pendek yang analitikal <div class="translation">Write a short, analytical essay</div></li>
          </ul>
        </div>
      </div>
    </div>

    <main class="py-4">
      <div class="mx-auto" style="max-width: var(--content-width);">
        <section id="stage" class="stage px-6 sm:px-10 lg:px-14 py-8 sm:py-10 md:py-12 card" aria-live="polite">
          <!-- Content will be dynamically loaded here -->
        </section>

        <!-- Kawalan Bawah -->
        <div class="mt-5 flex flex-wrap items-center justify-between gap-3 helper px-6 sm:px-10 lg:px-14">
          <div id="slide-counter" class="text-sm font-bold text-gray-600">Slide 1 / 16</div>
          <div class="flex items-center gap-2">
            <button id="prevBtn" class="btn btn-ghost">‚Üê Sebelumnya / Previous</button>
            <button id="nextBtn" class="btn btn-primary">Seterusnya / Next ‚Üí</button>
          </div>
        </div>

        <!-- Timing Guide -->
        <div class="mt-3 hint helper flex flex-wrap items-center gap-3 text-sm opacity-90 px-6 sm:px-10 lg:px-14">
          <span>‚è∞ Masa / Time:</span>
          <span id="slideTime">5 minit</span>
          <span>|</span>
          <span><kbd>‚Üê</kbd>/<kbd>‚Üí</kbd> navigasi / navigation</span>
          <span>|</span>
          <span><kbd>F</kbd> skrin penuh / fullscreen</span>
          <span>|</span>
          <span><kbd>P</kbd> cetak / print</span>
          <span>|</span>
          <span><kbd>+</kbd>/<kbd>-</kbd> zum / zoom</span>
          <span>|</span>
          <span><kbd>üí°</kbd> kamus visual / visual dictionary</span>
        </div>
      </div>
    </main>
  </div>

  <!-- Vocabulary Helper Widget -->
  <div class="vocab-helper">
    <button class="vocab-button" onclick="toggleVocabHelper()" title="Kamus Visual / Visual Dictionary">üí°</button>
    <div id="vocabPanel" class="vocab-panel">
      <div class="vocab-tabs">
        <div class="vocab-tab active" onclick="switchVocabTab(event, 'dictionary')">Kamus Visual</div>
        <div class="vocab-tab" onclick="switchVocabTab(event, 'starters')">Templat Ayat</div>
      </div>
      <div class="vocab-content" id="vocabContent">
        <!-- Content will be populated by JavaScript -->
      </div>
    </div>
  </div>

  <script>
    // --- STATE MANAGEMENT ---
    let currentSlide = 0;
    let studentName = '';
    let studentAnswers = {};
    let zoomLevel = 1.0;
    let workshopData = {
      title: '', intro: '', body1: '', conclusion: '',
      currentStep: 1, completed: false
    };

    // --- API KEYS & CONFIG ---
    const GIPHY_API_KEY = "535QMXdnUccXdDmUUZrk4Mr9GvCV3IEO"; 
    const GEMINI_API_KEY = "AIzaSyCcYYHdsZZXnb_fweeG6QHGF4hzO0n4lSI";

    // --- SLIDES DATA (REVAMPED) ---
    const slides = [
        // 1 ‚Äî Title
        { layout: 'title_revamped', title: 'Latihan Esei: Faedah Aktiviti Masa Lapang', title_en: 'Essay Practice: Benefits of Leisure Activities', timing: 3, starter: 'Selain daripada berehat, apakah satu kebaikan utama melakukan hobi kegemaran anda?', starter_en: 'Besides resting, what is one main benefit of doing your favourite hobby?' },
        // 2 ‚Äî Task Overview
        { layout: 'focus_card', title: 'Memahami Tugasan Esei', title_en: 'Understanding the Essay Task', timing: 5, content: 'Dalam tugasan ini, anda perlu menulis esei pendek untuk memberi pendapat dan justifikasi tentang faedah sesuatu aktiviti.', content_en: 'In this task, you need to write a short essay to give your opinion and justification about the benefits of an activity.' },
        // 3 ‚Äî Writing Guide
        { layout: 'writing_guide_revamped', title: 'Panduan Menulis Esei Yang Baik', title_en: 'A Guide to Good Essay Writing', timing: 5, goals: [
            { icon: 'üèóÔ∏è', text: 'Struktur yang Jelas', text_en: 'Clear Structure'},
            { icon: 'üìö', text: 'Kosa Kata Tepat', text_en: 'Precise Vocabulary'},
            { icon: 'üí°', text: 'Sebab dan Contoh', text_en: 'Reasons and Examples'}
        ]},
        // 4 ‚Äî Visual: Faedah Fizikal
        { layout: 'analysis_visual', title: 'Faedah Fizikal', title_en: 'Physical Benefits', gif: 'teenagers playing basketball', petikan: 'Aktiviti sukan seperti bola keranjang dan mendaki gunung dapat <strong>menyihatkan badan</strong>. Tambahan pula, ia <strong>menguatkan otot</strong> dan <strong>meningkatkan stamina</strong>.', timing: 4 },
        // 5 ‚Äî Task: Faedah Fizikal
        { layout: 'analysis_task', title: 'Faedah Fizikal', title_en: 'Physical Benefits', task: 'Nyatakan dua faedah fizikal yang disebut dalam petikan.', task_en: 'State two physical benefits mentioned in the passage.', answerId: 'analysis_1', timing: 5 },
        // 6 ‚Äî Visual: Faedah Mental
        { layout: 'analysis_visual', title: 'Faedah Mental', title_en: 'Mental Benefits', gif: 'playing chess', petikan: 'Hobi seperti bermain catur atau membaca buku boleh <strong>menajamkan minda</strong>. Aktiviti ini juga membantu <strong>mengurangkan tekanan</strong> selepas penat belajar.', timing: 4 },
        // 7 ‚Äî Task: Faedah Mental
        { layout: 'analysis_task', title: 'Faedah Mental', title_en: 'Mental Benefits', task: 'Bagaimanakah aktiviti masa lapang boleh membantu minda anda?', task_en: 'How can leisure activities help your mind?', answerId: 'analysis_2', timing: 5 },
        // 8 ‚Äî Visual: Faedah Sosial
        { layout: 'analysis_visual', title: 'Faedah Sosial', title_en: 'Social Benefits', gif: 'friends volunteering together', petikan: 'Menyertai aktiviti berpasukan membolehkan kita <strong>berkenalan dengan rakan baharu</strong>. Selain itu, ia mengajar kita nilai <strong>bekerjasama</strong>.', timing: 4 },
        // 9 ‚Äî Task: Faedah Sosial
        { layout: 'analysis_task', title: 'Faedah Sosial', title_en: 'Social Benefits', task: 'Berdasarkan petikan, tulis satu ayat penuh tentang mengapa faedah sosial adalah penting.', task_en: 'Based on the passage, write one full sentence about why social benefits are important.', answerId: 'analysis_3', timing: 5 },
        // 10 ‚Äî Vocabulary Summary
        { layout: 'overall_summary', title: 'Bank Perkataan Anda', title_en: 'Your Word Bank', timing: 5, instruction: 'Kumpulkan semua perkataan penting yang anda telah pelajari.', instruction_en: 'Collect all the important words you have learned.', categories: [{id: 'summary_physical', label: 'Faedah Fizikal'}, {id: 'summary_mental', label: 'Faedah Mental'}, {id: 'summary_social', label: 'Faedah Sosial'}] },
        // 11 ‚Äî Kata Hubung
        { layout: 'conjunction_practice', title: 'Kemahiran Menulis: Menyambung Idea', title_en: 'Writing Skill: Connecting Ideas', timing: 7 },
        // 12 ‚Äî Paragraph Structure Guide
        { layout: 'structure', title: 'Struktur Esei 3 Perenggan', title_en: '3-Paragraph Essay Structure', timing: 5, structure: [
            {part: 'Perenggan 1: Pengenalan', part_en: 'Paragraph 1: Introduction', desc: 'Nyatakan pendapat anda tentang kepentingan aktiviti masa lapang.', desc_en: 'State your opinion on the importance of leisure activities.'}, 
            {part: 'Perenggan 2: Huraian', part_en: 'Paragraph 2: Elaboration', desc: 'Berikan satu atau dua faedah beserta contoh. Gunakan kata hubung.', desc_en: 'Give one or two benefits with examples. Use conjunctions.'}, 
            {part: 'Perenggan 3: Penutup', part_en: 'Paragraph 3: Conclusion', desc: 'Rumuskan semula pendapat anda dan berikan harapan.', desc_en: 'Summarize your opinion and give a concluding hope.'}
        ] },
        // 13 - Rangka Karangan
        { layout: 'outline_planner', title: 'Langkah Perancangan: Rangka Esei Anda', title_en: 'Planning Step: Your Essay Outline', timing: 10 },
        // 14 ‚Äî Guided Writing Workshop
        { layout: 'guided_writing_workshop_revamped', gif: 'writing an essay', title: 'Bengkel Membina Esei', title_en: 'Essay Building Workshop', timing: 15 },
        // 15 - Final Work Display with AI Feedback
        { layout: 'final_work_feedback', title: 'Hasil Esei & Maklum Balas AI ‚ú®', title_en: 'Final Essay & AI Feedback ‚ú®', timing: 5 },
        // 16 - Final Summary
        { layout: 'final_summary', gif: 'success celebration', title: 'Latihan Selesai!', title_en: 'Practice Complete!', timing: 2, end_message: 'Anda telah melengkapkan latihan ini dengan jayanya. Syabas! Teruskan usaha anda.', end_message_en: 'You have completed this practice successfully. Well done! Keep up your efforts.' }
    ];

    // --- DATA ---
    const vocabularyData = {
      dictionary: [
        { bm: 'faedah', en: 'benefit', icon: 'üåü' },
        { bm: 'manfaat', en: 'advantage', icon: 'üëç' },
        { bm: 'menyihatkan badan', en: 'makes the body healthy', icon: 'üí™' },
        { bm: 'meningkatkan stamina', en: 'increase stamina', icon: 'üèÉ‚Äç‚ôÇÔ∏è' },
        { bm: 'menajamkan minda', en: 'sharpen the mind', icon: 'üß†' },
        { bm: 'mengurangkan tekanan', en: 'reduce stress', icon: 'üßò' },
        { bm: 'bekerjasama', en: 'cooperate', icon: 'ü§ù' },
        { bm: 'kemahiran sosial', en: 'social skills', icon: 'üó£Ô∏è' },
        { bm: 'justifikasi', en: 'justification', icon: '‚öñÔ∏è' },
        { bm: 'pendapat', en: 'opinion', icon: 'ü§î' }
      ],
      starters: [
        'Pada pendapat saya, aktiviti masa lapang memberi banyak faedah...',
        'Salah satu faedahnya ialah...',
        'Sebagai contoh, aktiviti seperti [nama hobi] dapat [faedah] kerana...',
        'Selain itu, ia juga membantu dalam...',
        'Tambahan pula, hobi ini membolehkan saya...',
        'Kesimpulannya, kita harus bijak mengisi masa lapang...'
      ]
    };

    // --- UTILITY FUNCTIONS ---
    const el = (selector) => document.getElementById(selector);
    const countWords = (text) => text.trim() === '' ? 0 : text.trim().split(/\s+/).length;

    function setZoom(level) {
        const mainEl = document.querySelector('main');
        if (mainEl) {
            mainEl.style.transformOrigin = 'top center';
            mainEl.style.transform = `scale(${level})`;
        }
    }

    function zoomIn() {
        zoomLevel = Math.min(1.5, zoomLevel + 0.1);
        setZoom(zoomLevel);
    }

    function zoomOut() {
        zoomLevel = Math.max(0.7, zoomLevel - 0.1);
        setZoom(zoomLevel);
    }
    
    function speakWord(text, event) {
        event.stopPropagation(); // Prevent text insertion when clicking the button
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ms-MY';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        } else {
            showToast('Maaf, pelayar anda tidak menyokong sebutan audio.');
        }
    }


    // --- API FUNCTIONS ---
    async function getExpandedSentence(inputId, outputId, context) {
        const inputEl = el(inputId);
        const outputEl = el(outputId);
        const text = inputEl.value;

        if (!text.trim()) {
            showToast('Sila tulis ayat anda terlebih dahulu. / Please write your sentence first.');
            return;
        }

        outputEl.style.display = 'block';
        outputEl.innerHTML = '<div class="loader" style="width:20px; height:20px;"></div>';

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const prompt = `You are an expert Malay language tutor assisting a Year 7 student. The student has written a simple sentence for their essay about the benefits of leisure activities. Your task is to rewrite it into a more formal and descriptive sentence. Provide two alternative suggestions. Format the output as a valid JSON object with a single key "suggestions" which is an array of two strings.\n\nStudent's sentence for the ${context}: "${text}"`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                }),
            });

            if (!response.ok) throw new Error(`API request failed: ${response.status}`);
            const data = await response.json();
            const result = JSON.parse(data.candidates[0].content.parts[0].text);
            
            if (result.suggestions && result.suggestions.length > 0) {
                let suggestionsHtml = '<p class="font-bold mb-2">Cadangan Ayat:</p><ul class="list-disc pl-5 space-y-2">';
                result.suggestions.forEach(s => {
                    suggestionsHtml += `<li>${s}</li>`;
                });
                suggestionsHtml += '</ul>';
                outputEl.innerHTML = suggestionsHtml;
            } else {
                throw new Error('No suggestions found.');
            }
        } catch (error) {
            console.error("Error fetching expanded sentence:", error);
            outputEl.innerHTML = '<p class="text-red-600">Gagal mendapatkan cadangan. Sila cuba lagi.</p>';
        }
    }

    async function getTranslation(textToTranslate, targetLang, outputElementId) {
        const outputEl = el(outputElementId);
        if (!textToTranslate.trim()) {
            outputEl.textContent = 'Sila masukkan perkataan. / Please enter a word.';
            return;
        }
        outputEl.innerHTML = '<div class="loader" style="width:20px; height:20px; margin: 0;"></div>';

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const sourceLang = targetLang === 'ms' ? 'English' : 'Malay';
        const prompt = `Translate the following word/phrase from ${sourceLang} to ${targetLang === 'ms' ? 'Malay' : 'English'}. Provide only the translated text, nothing else.\n\nText: "${textToTranslate}"`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                }),
            });

            if (!response.ok) throw new Error(`API request failed: ${response.status}`);

            const data = await response.json();
            const translatedText = data.candidates[0].content.parts[0].text.trim();
            outputEl.textContent = translatedText;
        } catch (error) {
            console.error("Error fetching translation:", error);
            outputEl.textContent = 'Terjemahan gagal. / Translation failed.';
        }
    }

    async function fetchGiphy(query, containerId) {
        const container = el(containerId);
        if (!container) return;
        container.innerHTML = '<div class="loader"></div>';
        try {
            const response = await fetch(`https://api.giphy.com/v1/gifs/translate?api_key=${GIPHY_API_KEY}&s=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error('Giphy API request failed');
            const data = await response.json();
            if (data.data && data.data.images && data.data.images.original.url) {
                container.innerHTML = `<img src="${data.data.images.original.url}" alt="${query}" class="w-full h-full object-cover">`;
            } else {
                container.innerHTML = '<p class="text-center text-gray-500">Imej tidak ditemui.</p>';
            }
        } catch (error) {
            console.error("Giphy fetch error:", error);
            container.innerHTML = '<p class="text-center text-red-500">Gagal memuatkan imej.</p>';
        }
    }

    async function getAIFeedbackFromAPI(text) {
        const feedbackContainer = el('ai-feedback-container');
        if (!feedbackContainer) return;
        feedbackContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="loader"></div><p class="text-gray-600 mt-2">AI sedang membaca tulisan anda...<br><span class="translation">AI is reading your writing...</span></p></div>`;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
        const prompt = `
            You are a friendly Malay language teacher. A Year 7 student has written a short essay about the benefits of their hobby.
            Provide constructive feedback in Malay, focusing on their argument.

            Student's essay:
            ---
            ${text}
            ---

            Provide feedback in these categories:
            1.  Kosa Kata (Vocabulary): Praise their use of formal words like 'faedah' or 'stamina'. Suggest ONE other relevant formal word. Provide the English translation.
            2.  Struktur Hujah (Argument Structure): Check if they supported their points with examples. Suggest how they could strengthen their argument.
            3.  Pujian (Praise): Give one positive and encouraging comment about their analytical thinking.

            Format the output as a valid JSON object with three keys: "Kosa Kata", "Struktur Hujah", and "Pujian".
            Each key should have a value of an array of HTML strings with your suggestions. Use <b> for highlighting words.
            Example:
            {
              "Kosa Kata": ["Penggunaan perkataan '<b>faedah</b>' sangat tepat! Anda juga boleh guna '<b>manfaat</b>' (advantage)."],
              "Struktur Hujah": ["Hujah anda baik! Untuk lebih meyakinkan, tambah satu contoh: 'Sebagai contoh, bermain catur <b>menajamkan minda</b> kerana kita perlu berfikir secara strategik.'"],
              "Pujian": ["Syabas kerana dapat menghuraikan kebaikan hobi anda!"]
            }
        `;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                }),
            });

            if (!response.ok) throw new Error(`API request failed: ${response.status}`);

            const data = await response.json();
            const feedbackJsonText = data.candidates[0].content.parts[0].text;
            const feedback = JSON.parse(feedbackJsonText);
            
            let feedbackHtml = '';
            const categoryMap = {
                "Pujian": { icon: "üëç", color: "text-green-700" },
                "Kosa Kata": { icon: "üîß", color: "text-blue-700" },
                "Struktur Hujah": { icon: "üîß", color: "text-blue-700" },
            };

            Object.entries(feedback).forEach(([category, items]) => {
                if (items.length > 0) {
                    const catInfo = categoryMap[category] || { icon: 'üí°', color: 'text-gray-700' };
                    feedbackHtml += `<div class="mb-4">
                            <h4 class="font-bold text-lg ${catInfo.color}">${catInfo.icon} ${category}</h4>
                            <ul class="list-disc pl-5 mt-2 space-y-2 text-sm">
                                ${items.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>`;
                }
            });
            feedbackContainer.innerHTML = feedbackHtml;
        } catch (error) {
            console.error("Error fetching AI feedback:", error);
            feedbackContainer.innerHTML = `<p class="text-red-600">Maaf, berlaku ralat semasa mendapatkan maklum balas AI. Sila cuba lagi nanti.</p>`;
        }
    }


    // --- SLIDE RENDERING (REVAMPED) ---
    function renderSlide(slideIndex) {
      const slide = slides[slideIndex];
      const stage = el('stage');
      stage.className = 'stage px-6 sm:px-10 lg:px-14 py-8 sm:py-10 md:py-12 card'; // Reset class
      let content = '';
      
      switch(slide.layout) {
        case 'title_revamped':
          stage.classList.add('stage-centered', 'text-center');
          if (!studentName) {
             content = `
              <div id="name-entry" class="w-full max-w-lg animate-fade-in">
                <h1 class="title mb-4">${slide.title}<p class="translation">${slide.title_en}</p></h1>
                <p class="text-xl mb-8 opacity-80">${slide.subtitle}<br><span class="translation">${slide.subtitle_en}</span></p>
                <div class="card p-6">
                  <label for="nameInput" class="font-bold text-lg block mb-3">Sila masukkan nama anda untuk mula:<br><span class="translation">Please enter your name to begin:</span></label>
                  <input type="text" id="nameInput" class="w-full text-center text-xl p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition mb-4" placeholder="Contoh: Ali bin Abu" value="">
                  <button id="startLessonBtn" class="btn btn-primary">Mula Belajar / Start Learning ‚Üí</button>
                </div>
              </div>`;
          } else {
            content = `
              <div class="w-full max-w-3xl animate-fade-in">
                <h1 class="title mb-4">${slide.title}<p class="translation">${slide.title_en}</p></h1>
                <p class="text-xl mb-8 opacity-80">${slide.subtitle}<br><span class="translation">${slide.subtitle_en}</span></p>
                <div class="card p-6 bg-gradient-to-br from-blue-50 to-indigo-100">
                  <p class="text-lg font-semibold mb-4">üí≠ Soalan Permulaan:<br><span class="translation">Starter Question:</span></p>
                  <p class="text-lg italic">${slide.starter}<br><span class="translation">${slide.starter_en}</span></p>
                </div>
              </div>`;
          }
          break;

        case 'focus_card':
            stage.classList.add('stage-centered', 'text-center');
            content = `
                <div class="w-full max-w-3xl animate-fade-in">
                    <h2 class="text-3xl font-bold mb-8">${slide.title}<p class="translation">${slide.title_en}</p></h2>
                    <div class="card p-8 stimulus-box">
                        <p class="text-xl">${slide.content}<br><span class="translation">${slide.content_en}</span></p>
                    </div>
                </div>
            `;
            break;
        
        case 'writing_guide_revamped':
            stage.classList.add('stage-centered', 'text-center');
            content = `
                <div class="w-full max-w-4xl animate-fade-in">
                    <h2 class="text-3xl font-bold mb-8">${slide.title}<p class="translation">${slide.title_en}</p></h2>
                    <div class="grid md:grid-cols-3 gap-6">
                        ${slide.goals.map(goal => `
                        <div class="card p-6">
                            <div class="text-4xl mb-3">${goal.icon}</div>
                            <h3 class="font-bold text-blue-800">${goal.text}</h3>
                            <p class="text-sm opacity-70 mt-1">${goal.text_en}</p>
                        </div>
                        `).join('')}
                    </div>
                </div>
            `;
            break;
        
        case 'analysis_visual':
            content = `
                <div class="animate-fade-in">
                    <h2 class="text-3xl font-bold mb-4">${slide.title}<p class="translation">${slide.title_en}</p></h2>
                    <div id="gif-${slideIndex}" class="gif-container mb-6 !h-[300px]"></div>
                    <div class="stimulus-box max-w-4xl mx-auto text-center">
                        <p class="text-lg">${slide.petikan}</p>
                    </div>
                </div>
            `;
            break;

        case 'analysis_task':
            content = `
                <div class="animate-fade-in">
                    <h2 class="text-3xl font-bold mb-6">${slide.title}<p class="translation">${slide.title_en}</p></h2>
                    <div class="grid lg:grid-cols-2 gap-8">
                        <div class="activity-box h-full flex flex-col">
                            <h3 class="font-bold text-lg mb-3">üìù Tugasan Anda<br><span class="translation">Your Task</span></h3>
                            <p class="mb-4">${slide.task}<br><span class="translation">${slide.task_en}</span></p>
                            <textarea id="${slide.answerId}" class="answer flex-grow" placeholder="Tulis jawapan anda di sini..."></textarea>
                            <button onclick="saveAnswer('${slide.answerId}')" class="btn btn-success mt-3 self-start">Simpan Jawapan</button>
                        </div>
                        <div class="help-center h-full">
                            <h3 class="font-bold text-lg mb-3">‚ú® Pusat Bantuan Bahasa<br><span class="translation">Language Help Center</span></h3>
                            <div class="space-y-2">
                                <h4 class="font-semibold text-sm">Pembantu Terjemahan Segera</h4>
                                <div class="flex items-center gap-2">
                                    <input type="text" id="translate-input-${slideIndex}" class="w-full text-sm p-2 border border-gray-300 rounded-lg" placeholder="Taip perkataan...">
                                    <button onclick="handleTranslationRequest(${slideIndex})" class="btn btn-ghost !p-2">Terjemah</button>
                                </div>
                                <div id="translate-output-${slideIndex}" class="text-sm font-bold text-blue-700 min-h-[1.5em] pt-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;
        
        case 'guided_writing_workshop_revamped':
            content = `
                <div class="animate-fade-in">
                    <h2 class="text-3xl font-bold mb-6">${slide.title}<p class="translation">${slide.title_en}</p></h2>
                    <div class="grid lg:grid-cols-12 gap-6">
                        <!-- Left: Outline -->
                        <div class="lg:col-span-3">
                            <div class="card p-4 bg-blue-50 h-full">
                                <h3 class="font-bold text-lg mb-3 text-blue-800">üìã Rangka Anda</h3>
                                <div class="space-y-3 text-sm">
                                    <div>
                                        <div class="font-semibold">Pendahuluan:</div>
                                        <div id="user-outline-intro" class="bg-white p-2 rounded text-xs opacity-75 min-h-[40px]"></div>
                                    </div>
                                    <div>
                                        <div class="font-semibold">Isi Utama:</div>
                                        <div id="user-outline-body" class="bg-white p-2 rounded text-xs opacity-75 min-h-[60px]"></div>
                                    </div>
                                     <div>
                                        <div class="font-semibold">Penutup:</div>
                                        <div id="user-outline-conclusion" class="bg-white p-2 rounded text-xs opacity-75 min-h-[40px]"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Center: Writing Area -->
                        <div class="lg:col-span-6">
                            <div class="card p-6 h-full">
                                <textarea id="finalArticle" class="answer" style="min-height: 300px;"></textarea>
                                <div class="flex justify-between items-center mt-3">
                                    <span class="text-sm text-gray-600">Bilangan Perkataan: <span id="workshopWordCount">0</span> / 120</span>
                                    <button onclick="completeWorkshop()" class="btn btn-success">‚úÖ Selesai & Semak</button>
                                </div>
                            </div>
                        </div>
                        <!-- Right: AI Helper -->
                        <div class="lg:col-span-3">
                             <div class="card p-4 bg-indigo-50 h-full">
                                <h3 class="font-bold text-lg mb-3 text-indigo-800">‚ú® Kembangkan Idea</h3>
                                 <p class="text-xs opacity-70 mb-3">Pilih perenggan yang anda tulis, kemudian klik butang di bawah untuk mendapatkan cadangan ayat yang lebih baik.</p>
                                <button onclick="getExpandedSentence('finalArticle', 'suggestions-workshop', 'selected text')" class="btn btn-ghost w-full">Dapatkan Cadangan</button>
                                <div id="suggestions-workshop" class="mt-3 text-sm p-3 bg-white border border-indigo-200 rounded-lg" ></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            break;

        // Fallback for old layouts to prevent breaking
        default:
            // Use old rendering logic for layouts that were not revamped
            const originalRenderFunction = getOriginalRenderFunction(slide);
            content = originalRenderFunction;
            break;
      }
      
      stage.innerHTML = content;
      
      // Post-render actions
      if (slide.layout.includes('visual') || slide.layout === 'final_summary') {
        fetchGiphy(slide.gif, `gif-${slideIndex}`);
      }
       if (slide.layout === 'guided_writing_workshop_revamped') {
        initializeWorkshopRevamped();
        loadUserAnalysis();
      }
      if (slide.layout === 'final_work_feedback') {
        const fullArticleText = [workshopData.title, workshopData.intro, workshopData.body1, workshopData.conclusion].filter(Boolean).join('\n\n');
        getAIFeedbackFromAPI(fullArticleText || studentAnswers.finalArticle || "Tiada teks untuk dianalisis.");
      }
      
      el('slide-counter').textContent = `Slide ${slideIndex + 1} / ${slides.length}`;
      el('slideTime').textContent = `${slide.timing} minit`;
      
      updateNav();
      loadAnswers(slideIndex);
    }
    
    function getOriginalRenderFunction(slide) {
        // This function contains the rendering logic from the previous version for non-revamped slides.
        switch(slide.layout) {
            case 'overall_summary':
                return `<div class="animate-fade-in"><h2 class="text-3xl font-bold mb-6">${slide.title}<p class="translation">${slide.title_en}</p></h2><p class="text-lg mb-8 opacity-80">${slide.instruction}<br><span class="translation">${slide.instruction_en}</span></p><div class="grid md:grid-cols-3 gap-6">${slide.categories.map(category => `<div class="card p-6"><h3 class="font-bold text-lg mb-4">${category.label}</h3><textarea id="${category.id}" class="answer" placeholder="Senaraikan perkataan..."></textarea></div>`).join('')}</div><div class="text-center mt-8"><button onclick="saveSummary()" class="btn btn-success">Simpan Bank Perkataan</button></div></div>`;
            case 'conjunction_practice':
                return `<div class="animate-fade-in"><h2 class="text-3xl font-bold mb-6">${slide.title}<p class="translation">${slide.title_en}</p></h2><div class="grid lg:grid-cols-2 gap-8"><div class="stimulus-box"><h3 class="font-bold text-lg mb-3">Apakah Kata Hubung?</h3><p>Kata hubung digunakan untuk menyambung dua ayat menjadi satu ayat yang lebih panjang dan menarik.</p><ul class="list-disc pl-5 mt-4 space-y-2"><li><b>dan</b> (and): untuk menambah maklumat.</li><li><b>kerana</b> (because): untuk memberi sebab.</li><li><b>tetapi</b> (but): untuk menunjukkan perbezaan.</li><li><b>selain itu</b> (besides that): untuk menambah isi baharu.</li></ul></div><div class="activity-box"><h3 class="font-bold text-lg mb-3">üìù Latihan Menggabung Ayat</h3><p class="mb-2">Ayat 1: Bersenam menyihatkan badan.</p><p class="mb-4">Ayat 2: Bersenam boleh mengurangkan tekanan.</p><label for="conjunction-answer" class="font-semibold text-sm">Gabungkan menggunakan 'dan':</label><textarea id="conjunction-answer" class="answer !min-h-[80px] mt-2" placeholder="Tulis ayat gabungan anda di sini..."></textarea><button onclick="saveAnswer('conjunction-answer')" class="btn btn-success mt-3">Simpan Jawapan</button></div></div></div>`;
            case 'structure':
                return `<div class="animate-fade-in"><h2 class="text-3xl font-bold mb-8 text-center">${slide.title}<p class="translation">${slide.title_en}</p></h2><div class="max-w-5xl mx-auto"><table class="structure-table"><thead><tr><th>Bahagian / Part</th><th>Tujuan / Purpose</th></tr></thead><tbody>${slide.structure.map(item => `<tr><td class="font-semibold">${item.part}<br><span class="translation">${item.part_en}</span></td><td>${item.desc}<br><span class="translation">${item.desc_en}</span></td></tr>`).join('')}</tbody></table></div></div>`;
            case 'outline_planner':
                return `<div class="animate-fade-in"><h2 class="text-3xl font-bold mb-6">${slide.title}<p class="translation">${slide.title_en}</p></h2><p class="text-lg opacity-80 mb-8 text-center">Rancang esei anda dengan mengisi nota ringkas di bawah sebelum menulis.</p><div class="max-w-4xl mx-auto space-y-6"><div class="card p-6"><h3 class="font-bold text-xl mb-3">1. Pendahuluan</h3><p class="text-sm opacity-70 mb-2">Apakah hobi dan faedah utama yang akan anda bincangkan?</p><textarea id="outline-intro" class="answer !min-h-[80px]" placeholder="cth: Hobi saya ialah berbasikal..."></textarea></div><div class="card p-6"><h3 class="font-bold text-xl mb-3">2. Isi Utama</h3><p class="text-sm opacity-70 mb-2">Senaraikan dua faedah dan berikan satu contoh bagi setiap satu.</p><textarea id="outline-body" class="answer" placeholder="cth: 1. Sihatkan badan... 2. Kurangkan tekanan..."></textarea></div><div class="card p-6"><h3 class="font-bold text-xl mb-3">3. Penutup</h3><p class="text-sm opacity-70 mb-2">Apakah rumusan dan harapan anda?</p><textarea id="outline-conclusion" class="answer !min-h-[80px]" placeholder="cth: Kesimpulannya, hobi ini sangat berfaedah..."></textarea></div></div><div class="text-center mt-8"><button onclick="saveOutline()" class="btn btn-success">Simpan Rangka Karangan</button></div></div>`;
             case 'final_work_feedback':
                return `<div class="animate-fade-in"><h2 class="text-3xl font-bold mb-6">${slide.title}<p class="translation">${slide.title_en}</p></h2><div class="max-w-6xl mx-auto"><div class="grid lg:grid-cols-2 gap-8"><div><h3 class="font-bold text-xl mb-3">Esei Anda</h3><div class="card p-6 h-full overflow-y-auto" style="max-height: 500px;"><h4 class="font-bold text-lg mb-4 text-center">${studentAnswers.finalArticle ? 'Esei Anda' : "(Tiada Esei)"}</h4><div class="space-y-4 text-left text-sm whitespace-pre-line"><p>${studentAnswers.finalArticle || "<em>(Tiada esei untuk dipaparkan)</em>"}</p></div></div></div><div><h3 class="font-bold text-xl mb-3">Maklum Balas Guru AI ‚ú®</h3><div id="ai-feedback-container" class="feedback-box h-full overflow-y-auto" style="max-height: 500px;"></div></div></div></div></div>`;
            case 'final_summary':
                return `<div class="animate-fade-in text-center flex flex-col items-center justify-center min-h-[50vh]"><div id="gif-${slideIndex}" class="gif-container mb-6 !h-48 max-w-sm"></div><h2 class="text-4xl font-bold mb-4">${slide.title}<p class="translation">${slide.title_en}</p></h2><p class="text-xl max-w-2xl">${slide.end_message}<br><span class="translation">${slide.end_message_en}</span></p></div>`;
            default: return '<div>Layout not found</div>';
        }
    }

    // --- EVENT HANDLERS & HELPERS ---
    // ... (rest of the functions like handleTranslationRequest, setupNameEntry, saveAnswer, saveSummary, saveOutline, loadAnswers)
    function handleTranslationRequest(slideIndex) {
        const inputEl = el(`translate-input-${slideIndex}`);
        const outputElId = `translate-output-${slideIndex}`;
        const text = inputEl.value;
        const isEnglish = /^[a-zA-Z\s.,!?']+$/.test(text);
        const targetLang = isEnglish ? 'ms' : 'en';
        getTranslation(text, targetLang, outputElId);
    }
    function setupNameEntry() {
        const nameInput = el('nameInput');
        const startBtn = el('startLessonBtn');
        if (!nameInput || !startBtn) return;
        const handleNameEntry = () => {
            const name = nameInput.value.trim();
            if (name) {
                studentName = name;
                el('studentNameDisplay').textContent = studentName;
                localStorage.setItem('mfl_student_name', studentName);
                renderSlide(currentSlide);
                updateNav();
                showToast(`Selamat datang, ${studentName}!`);
            } else {
                showToast('Sila masukkan nama anda terlebih dahulu.');
            }
        };
        startBtn.addEventListener('click', handleNameEntry);
        nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleNameEntry(); });
    }
    function saveAnswer(answerId) {
      const textarea = el(answerId);
      if (textarea) {
        studentAnswers[answerId] = textarea.value;
        localStorage.setItem('mfl_student_answers', JSON.stringify(studentAnswers));
        showToast('Jawapan disimpan!');
      }
    }
    function saveSummary() {
      ['summary_physical', 'summary_mental', 'summary_social'].forEach(id => {
        const textarea = el(id);
        if (textarea) studentAnswers[id] = textarea.value;
      });
      localStorage.setItem('mfl_student_answers', JSON.stringify(studentAnswers));
      showToast('Bank perkataan disimpan!');
    }
    function saveOutline() {
        ['outline-intro', 'outline-body', 'outline-conclusion'].forEach(id => {
            const textarea = el(id);
            if (textarea) studentAnswers[id] = textarea.value;
        });
        localStorage.setItem('mfl_student_answers', JSON.stringify(studentAnswers));
        showToast('Rangka karangan disimpan!');
    }
    function loadAnswers(slideIndex) {
      const slide = slides[slideIndex];
      const answerIds = {
          'analysis_task': [slide.answerId],
          'overall_summary': slide.categories.map(c => c.id),
          'conjunction_practice': ['conjunction-answer'],
          'outline_planner': ['outline-intro', 'outline-body', 'outline-conclusion']
      }[slide.layout] || [];
      
      answerIds.forEach(id => {
          const input = el(id);
          if (input && studentAnswers[id]) input.value = studentAnswers[id];
      });
    }

    function loadUserAnalysis() {
      const data = studentAnswers;
      const setContent = (id, text) => {
        const element = el(id);
        if(element) element.textContent = text || 'Belum diisi...';
      };
      if (el('user-outline-intro')) {
        setContent('user-outline-intro', data['outline-intro'] || '');
        setContent('user-outline-body', data['outline-body'] || '');
        setContent('user-outline-conclusion', data['outline-conclusion'] || '');
      }
    }
    
    // --- WORKSHOP LOGIC (REVAMPED) ---
    function initializeWorkshopRevamped() {
      const textarea = el('finalArticle');
      const wordCountEl = el('workshopWordCount');
      if (textarea) {
          textarea.value = studentAnswers.finalArticle || '';
          textarea.addEventListener('input', function() {
              const words = countWords(textarea.value);
              if(wordCountEl) wordCountEl.textContent = words;
              studentAnswers.finalArticle = textarea.value; // Live save
          });
      }
    }

    function completeWorkshop() {
        const textarea = el('finalArticle');
        if (textarea) {
            studentAnswers.finalArticle = textarea.value;
            localStorage.setItem('mfl_student_answers', JSON.stringify(studentAnswers));
        }
        workshopData.completed = true;
        updateNav();
        showToast('Esei disimpan! Anda boleh ke slaid seterusnya.');
        nextSlide();
    }

    // --- NAVIGATION ---
    function nextSlide() { if (currentSlide < slides.length - 1) goToSlide(currentSlide + 1); }
    function prevSlide() { if (currentSlide > 0) goToSlide(currentSlide - 1); }
    function goToSlide(slideIndex) {
        if (slideIndex > 0 && !studentName) {
            showToast("Sila masukkan nama anda untuk memulakan pelajaran.");
            return;
        }
        currentSlide = slideIndex;
        localStorage.setItem('mfl_current_slide', currentSlide);
        renderSlide(currentSlide);
    }
    function updateNav() {
        const prevBtn = el('prevBtn');
        const nextBtn = el('nextBtn');
        const onWorkshopSlide = slides[currentSlide].layout === 'guided_writing_workshop_revamped';

        prevBtn.disabled = currentSlide === 0;
        
        // On the new workshop, there's no step-by-step blocking, so we don't check for workshopData.completed
        nextBtn.disabled = (currentSlide === slides.length - 1) || (currentSlide === 0 && !studentName);

        nextBtn.textContent = (currentSlide === slides.length - 1) ? 'Tamat / End' : 'Seterusnya / Next ‚Üí';
    }

    // --- VOCABULARY HELPER ---
    // ... (same as before) ...
    let vocabPanelOpen = false;
    let currentVocabTab = 'dictionary';
    function toggleVocabHelper() {
        const panel = el('vocabPanel');
        vocabPanelOpen = !vocabPanelOpen;
        panel.classList.toggle('show', vocabPanelOpen);
        if (vocabPanelOpen) renderVocabContent();
    }
    function switchVocabTab(event, tabName) {
        currentVocabTab = tabName;
        document.querySelectorAll('.vocab-tab').forEach(tab => tab.classList.remove('active'));
        event.currentTarget.classList.add('active');
        renderVocabContent();
    }
    function renderVocabContent() {
        const content = el('vocabContent');
        let html = '';
        if (currentVocabTab === 'dictionary') {
            html = `<h4 class="font-bold mb-3">Kamus Visual</h4> ${vocabularyData.dictionary.map(item => `<div class="vocab-item" onclick="insertText('${item.bm} ')"><span class="vocab-icon">${item.icon}</span><span class="flex-grow"><b>${item.bm}</b> - ${item.en}</span><button class="speak-btn" onclick="speakWord('${item.bm}', event)">üîä</button></div>`).join('')}`;
        } else if (currentVocabTab === 'starters') {
            html = `<h4 class="font-bold mb-3">üöÄ Templat Ayat</h4> ${vocabularyData.starters.map(starter => `<div class="vocab-item" onclick="insertText('${starter} ')">${starter}</div>`).join('')}`;
        }
        content.innerHTML = html;
    }
    function insertText(text) {
        const activeEl = document.activeElement;
        if (activeEl && (activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'INPUT')) {
            const start = activeEl.selectionStart;
            const end = activeEl.selectionEnd;
            const textToInsert = text.replace(/\[.*?\]/g, '');
            activeEl.value = activeEl.value.substring(0, start) + textToInsert + activeEl.value.substring(end);
            activeEl.setSelectionRange(start + textToInsert.length, start + textToInsert.length);
            activeEl.dispatchEvent(new Event('input'));
            activeEl.focus();
        } else {
            showToast('Sila klik dalam kotak teks dahulu.');
        }
    }

    // --- GENERAL & INITIALIZATION ---
    function showToast(message) {
      const toastContainer = el('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toastContainer.removeChild(toast), 500);
      }, 3000);
    }

    function init() {
        studentName = localStorage.getItem('mfl_student_name') || '';
        if(studentName) el('studentNameDisplay').textContent = studentName;
        studentAnswers = JSON.parse(localStorage.getItem('mfl_student_answers') || '{}');
        const savedSlide = parseInt(localStorage.getItem('mfl_current_slide'), 10);
        currentSlide = !isNaN(savedSlide) && studentName ? savedSlide : 0;

        el('prevBtn').addEventListener('click', prevSlide);
        el('nextBtn').addEventListener('click', nextSlide);
        el('toggleObj').addEventListener('click', (e) => {
            const list = el('objList');
            const isHidden = list.style.display === 'none';
            list.style.display = isHidden ? 'grid' : 'none';
            e.target.textContent = isHidden ? 'Buka / Show' : 'Sembunyi / Hide';
        });
        
        document.addEventListener('keydown', e => {
            if (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT') return;
            if (e.key === 'ArrowRight' && !el('nextBtn').disabled) nextSlide();
            if (e.key === 'ArrowLeft' && !el('prevBtn').disabled) prevSlide();
            if (e.key.toLowerCase() === 'f') document.documentElement.requestFullscreen().catch(console.error);
            if (e.key.toLowerCase() === 'p') window.print();
            if (e.key === 'üí°') toggleVocabHelper();
            if (e.key === '+' || e.key === '=') zoomIn();
            if (e.key === '-') zoomOut();
        });

        document.addEventListener('click', function(e) {
            const helper = document.querySelector('.vocab-helper');
            if (helper && !helper.contains(e.target) && vocabPanelOpen) {
                toggleVocabHelper();
            }
        });
        renderSlide(currentSlide);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
" and am asking the following query:
Make sure to answer the question using the most up-to-date document.

Can I know the overall changes from the previous version to the current version?


